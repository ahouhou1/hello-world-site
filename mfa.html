<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MFA</title>
  <link rel="stylesheet" href="css/style.css"/>
  <style>
    .muted{ color: var(--muted); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .qrbox{ border:1px solid rgba(255,255,255,.15); border-radius:12px; padding:12px; display:inline-block; }
  </style>
</head>
<body>
<main class="card" style="max-width:520px;margin:4rem auto;padding:1.2rem">
  <h2 id="title">Two-Factor Authentication</h2>
  <div id="enroll" class="mt-2 hidden">
    <p class="muted">Scan this with Google/Microsoft Authenticator, then enter the 6-digit code.</p>
    <div id="qr" class="qrbox mt-2"></div>
    <p class="mt-2"><small class="muted">If you can't scan, add this key manually:</small></p>
    <p class="mono" id="secret"></p>
    <form id="enrollForm" class="mt-2">
      <label>6-digit code<input id="enrollCode" inputmode="numeric" pattern="[0-9]*" required /></label>
      <button class="button" type="submit">Verify & Enable</button>
    </form>
  </div>

  <div id="challenge" class="mt-2 hidden">
    <p class="muted">Enter the 6-digit code from your authenticator app.</p>
    <form id="challengeForm" class="mt-2">
      <label>6-digit code<input id="challengeCode" inputmode="numeric" pattern="[0-9]*" required /></label>
      <button class="button" type="submit">Verify</button>
    </form>
  </div>

  <p id="msg" class="mt-2 muted"></p>
</main>

<script type="module">
import { supabase } from "./js/supabase.js";

const params = new URLSearchParams(location.search);
const mode = params.get("mode") || "challenge";
const msg = document.getElementById("msg");
const elEnroll = document.getElementById("enroll");
const elChal = document.getElementById("challenge");
const title = document.getElementById("title");

// Render QR helper without external libs (optional external service for QR)
function renderQR(data){
  const url = "https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=" + encodeURIComponent(data);
  const img = new Image(); img.src = url; img.alt = "QR Code";
  const box = document.getElementById("qr"); box.innerHTML = ""; box.appendChild(img);
}

if (mode === "enroll") {
  title.textContent = "Enable Two-Factor Authentication";
  elEnroll.classList.remove("hidden");
  // 1) Start enrollment
  const { data, error } = await supabase.auth.mfa.enroll({ factorType: "totp" });
  if (error) { msg.textContent = "❌ " + error.message; throw error; }
  const { id: factorId, totp } = data; // totp: { qr_code, secret, uri }
  sessionStorage.setItem("mfa_enroll_factor_id", factorId);
  // Show QR / secret to user
  renderQR(totp.uri);
  document.getElementById("secret").textContent = totp.secret;

  // 2) Verify code user types
  document.getElementById("enrollForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const code = (document.getElementById("enrollCode").value || "").trim();
    const fid = sessionStorage.getItem("mfa_enroll_factor_id");
    msg.textContent = "Verifying…";
    const { error: vErr } = await supabase.auth.mfa.verify({ factorId: fid, code });
    if (vErr) { msg.textContent = "❌ " + vErr.message; return; }
    msg.textContent = "✅ 2FA enabled!";
    // done → go to dashboard
    setTimeout(()=> location.href = "dashboard.html", 600);
  });

} else {
  title.textContent = "Verify Code";
  elChal.classList.remove("hidden");
  // Start a challenge using the enrolled factor
  let factorId = sessionStorage.getItem("mfa_factor_id");
  if (!factorId) {
    // If not stored, fetch factors and pick verified TOTP
    const { data: factorsData } = await supabase.auth.mfa.listFactors();
    const f = factorsData?.factors?.find(f => f.factor_type === "totp" && f.status === "verified");
    factorId = f?.id;
  }
  if (!factorId) { msg.textContent = "No TOTP factor found. Please enroll."; location.href="mfa.html?mode=enroll"; }

  const { data: challenge, error: cErr } = await supabase.auth.mfa.challenge({ factorId });
  if (cErr) { msg.textContent = "❌ " + cErr.message; throw cErr; }
  sessionStorage.setItem("mfa_challenge_id", challenge.id);

  document.getElementById("challengeForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const code = (document.getElementById("challengeCode").value || "").trim();
    const challengeId = sessionStorage.getItem("mfa_challenge_id");
    msg.textContent = "Checking…";
    const { error: vErr } = await supabase.auth.mfa.verify({ factorId, code, challengeId });
    if (vErr) { msg.textContent = "❌ " + vErr.message; return; }
    msg.textContent = "✅ Verified!";
    setTimeout(()=> location.href = "dashboard.html", 600);
  });
}
</script>
</body>
</html>
